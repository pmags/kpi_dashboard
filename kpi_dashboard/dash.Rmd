---
title: "Cruise Control"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    logo: www/bar-chart.png
    orientation: rows
    vertical_layout: fill
    css: www/my_theme.css
    #source_code: "https://github.com/pmags/kpi_dashboard"
    navbar:
      - { icon: "fa-question-circle", href: "https://forms.gle/9TjB3hsFsvqjJrA57", align: right }
---

```{r eval=FALSE, include=FALSE}
# TODO: conciliar mapas financeiros
# TODO: mapa de controlo das conciliações

## names:
# q_ query to database
```

```{r setup, include=FALSE}

# libraries
library(flexdashboard) # dashboard framework
library(tidyverse) # for data wrangling
library(lubridate)
library(RPostgres) # connects to database
library(RPostgreSQL) # sql functions
library(plotly) # allows for web friendly graphs
library(DT) # allows for web friendly data table
library(viridis) # plot color
library(shinysky)
library(shinyWidgets)
library(caret) # predictive models

source("R/functions.R") # helper functions used during the project
source("R/sql.R") # helper with sql queries

# Theme set for all plots
theme_set(
  theme_minimal() +
    theme(legend.position = "right"))

# connection to data base server
con <- dbConnect(RPostgres::Postgres(),
                dbname = "nors",
                host = "89.154.64.8",
                port = 5433,
                user = "pi",
                password = "admin")
```


Sidebar {.sidebar}
====================================================================

```{r sidebar selector}
# TODO: O selector de anos tem de apresentar os anos correspondentes à base de dados de cada uma das empresas.

# define arguments
company <- dbGetQuery(con,"SELECT vat_number, name FROM company;")
years <- dbGetQuery(con, "SELECT DISTINCT year FROM statements;")

# Gets company names from database
Encoding(company$name) <- "UTF-8" # corrects encoding for R
choices <- split(company$vat_number, company$name) # splits dataframe into a list

# company selector
div(style = "font-size:9pt",
    selectInput("company_select", h5("Empresa:"), 
                       choices = choices, selected = "Galius"))

# year selector
div(style = "font-size:9pt",
    sliderInput(inputId = "year_slider",
                label = h5("Período:"),
                min = min(years), max = max(years),
                value = c(max(years)-5,max(years)), 
                sep ="",
                step = 1)
     
    )

# choose year index to be used
div(style = "font-size:9pt",
  selectInput(
     inputId = "index_year",
     label = h5("Ano base:"), 
     choices = sort(pull(years)),
     selected = "2017"
  )
)

# include interimn information
div(style = "font-size:9pt",
  shinyWidgets::materialSwitch(
     inputId = "interim",
     label = h5("Incluir interino:"),
     value = TRUE,
     status = "info"
  )
)


```

O selector **Empresa** permite alterar a entidade apresentada. Podem ser seleccionados para análise entre um ano e todos os disponíveis. Por defeito, serão apresentados os últimos 5 anos.

A informação interina pode ser retirada caso se pretenda obter uma análise exclusivamente do final de cada ano. É importante ter em atenção durante a interpretação dos dados que nos casos devidamente assinalados, **a informação interina poderá ser apresentada extrapolada para 12 meses**.

Os mapas financeiros podem ser guardados em formato CSV, EXCEL ou PDF através da opção guardar no separados **Mapas**

Resumo
=======================================================================

```{r summary data query}

sales_kpi <- reactive({
    # query to database that reacts to the company choosen
    dbGetQuery(con,sqlInterpolate(ANSI(),
                                  q_sales_kpi,
                                  vat = input$company_select)) %>%
    # inline accounts become columns/ become features
      spread(account, value) %>%
    # all NA replace by zero. NA arise from original information everytime a number is no aplicable
      replace(., is.na(.),0) %>%
    # calculate kpi (keep in mind that credit means profit)
      mutate(
        margem_bruta = (A00001 + A00006)/A00001,
        margem_ebitda = abs(A00018/A00001),
        pessoal_vendas = abs(A00008/A00001),
        fse_vendas = abs(A00007/A00001),
        outros_vendas = (A00016 + A00017)/A00001
        )%>%
    # if statement in case we want to exclude interim information
      filter(if (input$interim == FALSE) month == 12 else month == month ) %>% 
    # filter for selecting period
      filter(year >= min(input$year_slider) & year <= max(input$year_slider)) %>% 
    # convert to data for later plot
      mutate(date = ymd(paste0(year,"-",month,"-01"))) %>%
      select(-vat_number, -year, -month) %>%
      select(date,everything()) %>%
      arrange(desc(date))
  })

```


Row {data-width = 500}
-----------------------------------------------------------------------

### Performance

```{r plot main kpi}

renderPlotly(
  
    sales_kpi() %>% 
    select(-starts_with(ignore.case = TRUE, "A")) %>%  # only selects kpi
    gather("kpi","value",-date) %>% # converts from column to row
    # converting to factor so that ggplot can plot simultaneously
    mutate(kpi = factor(kpi)) %>% 
    mutate(kpi = forcats::fct_recode(kpi, "Margem Bruta(%)" = "margem_bruta", 
                                     "Margem Ebitda(%)" = "margem_ebitda", 
                                     "Pessoal (%)" = "pessoal_vendas",
                                     "FSE (%)" = "fse_vendas",
                                     "Outros (%)" = "outros_vendas")) %>%
    # in order to exclude missing values we convert all infinite to na and then all na to zero
    mutate_if(is.numeric,list(~na_if(abs(.), Inf))) %>% 
    replace(., is.na(.),0) %>% 
    mutate(date = format(date, "%Y-%m")) %>% 
    # TODO: Rever a função de plotagem
    ggplot(aes(x = date, y = value, group = kpi)) + 
    geom_line(aes(color = kpi))+
    geom_point(aes(color = kpi)) +
    scale_color_brewer(palette="Dark2")+
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    labs( x="",y = "", color = "") +
    theme(legend.position="top")
  )

```


Column {data-width=333}
-----------------------------------------------------------------------

### Vendas 

```{r plot sales}
renderPlotly(
  sales_kpi() %>% 
    select(date, vendas = A00001) %>%
    # converts interimn sales to yearly
    mutate(month = month(date), 
           vendas = abs(vendas/month*12)) %>% 
    ggplot(aes(x = date, y = vendas)) +
    geom_area(fill="#69b3a2", alpha=0.4) +
    geom_line(color="#69b3a2") +
    geom_point(size = 0.5, color="#69b3a2") +
    scale_y_continuous(labels = ks) +
    labs(x="",y = "")
)
```

> tttt

### Variação vendas

```{r plot sales index}
# TODO: Corrigir tendo em conta que nos meses que exista informação interina também há informação do mês

renderPlotly(
  sales_kpi() %>% 
    select(date, vendas = A00001) %>% 
    # converts interimn sales to yearly
    mutate(month = month(date), vendas = abs(vendas/month * 12),
           base = abs(sales_kpi()$A00001[which(year(sales_kpi()$date) == input$index_year)]),
           index = vendas/base) %>% 
    ggplot(aes(x = date, y = index)) + 
    geom_area(fill = "#e39220", alpha = 0.4) +
    geom_line(color = "#e39220") +
    geom_point(size = 0.5, color = "#e39220") +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    labs(x="",y="")
)

```

> tttt

### Cobertura corrente

```{r}

renderPlotly({
  
  # data based on query
  reactive({
    dbGetQuery(con, sqlInterpolate(ANSI(), q_wc, vat = input$company_select)) %>% 
      spread(account, value) %>% 
      replace(., is.na(.),0) %>% 
      mutate(cobertura = ((A00125 - A00124 - A00119 - A00117) + (A00156 - A00151 - A00149))/abs(A00001) * 365) %>% 
      filter(if(input$interim == FALSE) month == 12 else month == month) %>% 
      filter(year >= min(input$year_slider) & year <= max (input$year_slider)) %>% 
      mutate(date = ymd(paste0(year,"-",month,"-01"))) %>%
      select(-vat_number, -year, -month) %>%
      select(date,everything()) %>%
      arrange(desc(date))})() %>% 
    select(-starts_with(ignore.case = TRUE, "A")) %>%  # only selects kpi
    mutate_if(is.numeric,list(~na_if(abs(.), Inf))) %>% 
    replace(., is.na(.),0) %>% 
    ggplot(aes(x = date, y = cobertura)) + 
    geom_area(fill = "#3c6788", alpha = 0.4) +
    geom_line(color = "#3c6788") +
    geom_point(size = 0.7, color = "#3c6788") +
    labs(x="",y="")
    
}) 
```

> tttt

Mapas
=======================================================================

```{r}

df <- reactive({
  dbGetQuery(con,sqlInterpolate(ANSI(), q_df, vat = input$company_select)) %>%
    filter(if (input$interim == FALSE) month == 12 else month == month ) %>% 
    filter(year >= min(input$year_slider) & year <= max(input$year_slider)) %>%
    mutate(date = ymd(paste0(year,"-",month,"-01")), 
           date = format(date, "%m-%Y")) %>%
    arrange(desc(date)) %>% 
    select(-year, -month,-vat_number) %>%
    spread(date, value) %>%
    select(rubrica = name_pt, everything())
})

```

```{r}
fun_bal <- reactive({
  dbGetQuery(con,sqlInterpolate(ANSI(), q_fun_bal,vat = input$company_select)) %>%
    filter(if (input$interim == FALSE) month == 12 else month == month ) %>% 
    filter(year >= min(input$year_slider) & year <= max(input$year_slider)) %>%
    mutate(date = ymd(paste0(year,"-",month,"-01")), 
           date = format(date, "%m-%Y")) %>%
    arrange(desc(date)) %>% 
    select(-year, -month,-vat_number) %>%
    spread(date, value) %>%
    select(rubrica = name_pt, everything())
})

```

```{r}
cf <- reactive({
  dbGetQuery(con,sqlInterpolate(ANSI(), q_cashflow, vat = input$company_select)) %>%
    filter(if (input$interim == FALSE) month == 12 else month == month ) %>% 
    filter(year >= min(input$year_slider) & year <= max(input$year_slider)) %>%
    mutate(date = ymd(paste0(year,"-",month,"-01")), 
           date = format(date, "%m-%Y")) %>%
    arrange(desc(date)) %>% 
    select(-year, -month,-vat_number) %>%
    spread(date, value) %>%
    select(rubrica = name_pt, everything())
})

```



Column {.tabset}
-----------------------------------------------------------------------

### Balanço

```{r}

renderDataTable(
  df() %>%
  filter(financial_statement == "bs") %>%
  select(-financial_statement) %>%
  DT::datatable(
  rownames = FALSE,
  extensions = "Buttons",
  options = list(
    # adds buttons
    dom = 'Bfrtip',
    buttons = c("copy", "csv", "excel","pdf","print"),
    # number of entries on display
    pageLength = 100,
    initComplete = JS(
       "function(settings, json) {",
        "$(this.api().table().header()).css({'font-size': '8pt'});",
        "}"
    )),
  fillContainer = TRUE) %>%
  DT::formatStyle(colnames(select(df(),-financial_statement)), fontSize = "8pt") %>%
  DT::formatStyle("account",
                  target = "row",
                  fontWeight = styleEqual(c("A00112","A00125","A00126","A00136","A00139","A00145","A00156","A00157","A00158"),
                                          c("bold","bold","bold","bold","bold","bold","bold","bold","bold"))) %>%
  DT::formatRound(columns = colnames(select(df(),-financial_statement,-rubrica,-account)), digits = 0, mark = ".")

)

```

### Demonstração de resultados

```{r}

renderDataTable(
  
  df() %>% 
  filter(financial_statement == "pl") %>%
  select(-financial_statement) %>% 
  DT::datatable(
  rownames = FALSE,
  extensions = "Buttons",
  options = list(
    # adds buttons
    dom = 'Bfrtip',
    buttons = c("copy", "csv", "excel","pdf","print"),
    # number of entries on display
    pageLength = 100,
    initComplete = JS(
       "function(settings, json) {",
        "$(this.api().table().header()).css({'font-size': '8pt'});",
        "}"
    )), 
  fillContainer = TRUE) %>% 
  DT::formatStyle(colnames(select(df(),-financial_statement)), fontSize = "8pt") %>%
  DT::formatStyle("account",
                  target = "row", 
                  fontWeight = styleEqual(c("A00018","A00021","A00024","A00026"),
                                          c("bold","bold","bold","bold"))) %>% 
  DT::formatRound(columns = colnames(select(df(),-financial_statement,-rubrica,-account)), digits = 0, mark = ".")
  
  )

```

### Balanço funcional

```{r}
# TODO: É necessário conciliar os totais porque não estão certos

renderDataTable(
  
  fun_bal() %>% 
  DT::datatable(
  rownames = FALSE,
  extensions = "Buttons",
  options = list(
    # adds buttons
    dom = 'Bfrtip',
    buttons = c("copy", "csv", "excel","pdf","print"),
    # number of entries on display
    pageLength = 100,
    initComplete = JS(
       "function(settings, json) {",
        "$(this.api().table().header()).css({'font-size': '8pt'});",
        "}"
    )), 
  fillContainer = TRUE) %>% 
  DT::formatStyle(colnames(fun_bal()), fontSize = "8pt") %>%
  DT::formatStyle("funcional_code",
                  target = "row", 
                  fontWeight = styleEqual(c("F0005","F0011","F0016","F0017","F0020"),
                                          c("bold","bold","bold","bold","bold"))) %>% 
  DT::formatRound(columns = colnames(select(fun_bal(),-rubrica,-funcional_code)), digits = 0, mark = ".")
  
  )

```

### Fluxo de caixa (anual)

```{r}

renderDataTable(
  
  cf() %>% 
  DT::datatable(
  rownames = FALSE,
  extensions = "Buttons",
  options = list(
    # adds buttons
    dom = 'Bfrtip',
    buttons = c("copy", "csv", "excel","pdf","print"),
    # number of entries on display
    pageLength = 100,
    initComplete = JS(
       "function(settings, json) {",
        "$(this.api().table().header()).css({'font-size': '8pt'});",
        "}"
    )), 
  fillContainer = TRUE) %>% 
  DT::formatStyle(colnames(cf()), fontSize = "8pt") %>%
  DT::formatStyle("cf_code",
                  target = "row", 
                  fontWeight = styleEqual(c("CF006","CF007","CF012","CF018","CF019","CF023","CF024"),
                                          c("bold","bold","bold","bold","bold","bold","bold"))) %>% 
  DT::formatRound(columns = colnames(select(cf(),-rubrica,-cf_code)), digits = 0, mark = ".")
  
  )

```


<!-- Liquidity & Solvency {data-navmenu=Details} -->
<!-- ======================================================================= -->

<!-- Row {data-width=500} -->
<!-- ----------------------------------------------------------------------- -->

<!-- ### Cash generation -->

<!-- ```{r} -->

<!-- cash_kpi <-   reactive({ -->
<!--   fun_bal() %>% -->
<!--     filter(funcional_code == "F0017") %>% -->
<!--     rename(account = funcional_code) %>%  -->
<!--     rbind(df() %>%  -->
<!--             select(-financial_statement) %>%  -->
<!--             filter(account %in% c("A00001","A00113","A00115","A00146","A00006","A00007"))) %>%  -->
<!--     replace(., is.na(.),0) %>%  -->
<!--     select(-rubrica) %>%  -->
<!--     gather(key = "date",value = "value", contains("20")) %>%  -->
<!--     spread(key = account,value = value) %>%  -->
<!--     mutate(date = ymd(date), -->
<!--            dwc = F0017 * 365/abs(A00001), -->
<!--            tme = A00113/A00006 * 365, -->
<!--            tmr = A00115/abs(A00001) * 365, -->
<!--            tmp = -A00146/(A00006+A00007)*365, -->
<!--            ccc = tme + tmr - tmp) -->
<!--   }) -->

<!-- renderPlotly( -->

<!--   cash_kpi() %>%  -->
<!--     gather("kpi","value",-contains("date")) %>%  -->
<!--     mutate(kpi = factor(kpi)) %>%  -->
<!--     filter(kpi %in% c("dwc","ccc")) %>%   -->
<!--     ggplot(aes(x = date, y = value, group = kpi)) + -->
<!--     geom_line(aes(color = kpi))+ -->
<!--     geom_point(aes(color = kpi))+ -->
<!--     scale_color_brewer(palette="Dark2")+ -->
<!--     labs( x="",y = "") + -->
<!--     theme(legend.position="top") -->

<!-- ) -->

<!-- ``` -->

<!-- > Cash converstion cycle and Working Capital in days -->

<!-- ### Decomposition -->



<!-- Row {data-width=500} -->
<!-- ----------------------------------------------------------------------- -->

<!-- ### Liquidity -->

<!-- ```{r} -->

<!-- liq_kpi <- reactive({ -->
<!--   df() %>%  -->
<!--     select(-financial_statement,-rubrica) %>%  -->
<!--     filter(account %in% c("A00124","A00115","A00113","A00156")) %>%  -->
<!--     replace(., is.na(.),0) %>% -->
<!--     gather(key = "date", value = "value",contains("20")) %>%  -->
<!--     spread(key = account, value = value) %>%  -->
<!--     mutate( -->
<!--       date = ymd(date), -->
<!--       liq_geral = (A00115 + A00124 + A00113) / -A00156, -->
<!--       liq_reduzida = (A00115 + A00124 ) / -A00156, -->
<!--       liq_imediata = A00124 / -A00156 -->
<!--     ) -->

<!--   }) -->

<!-- renderPlotly( -->

<!--   liq_kpi() %>%  -->
<!--     gather("kpi","value",-contains("date")) %>%  -->
<!--     mutate(kpi = factor(kpi)) %>%  -->
<!--     filter(kpi %in% c("liq_geral", "liq_reduzida", "liq_imediata")) %>%  -->
<!--     ggplot(aes(x = date, y = value, fill = kpi)) +  -->
<!--     geom_area(alpha=0.4) + -->
<!--     scale_fill_brewer(palette="Dark2")+ -->
<!--     scale_y_continuous(labels = scales::percent_format(accuracy = 1)) + -->
<!--     labs( x="",y = "") + -->
<!--     theme(legend.position="top") -->
<!-- ) -->

<!-- ``` -->

<!-- > Current ratio, Quick Ratio, Acid test ratio -->


<!-- ### Net Debt to Ebitda -->

<!-- ```{r} -->

<!-- kpi00010 <- reactive({dbGetQuery(con,sqlInterpolate(ANSI(), -->
<!--                                 "SELECT -->
<!--                                   vat_number, account,year,month,value -->
<!--                                 FROM -->
<!--                                   ( SELECT -->
<!--                                         vat_number, account,year,month,value -->
<!--                                     FROM -->
<!--                                         statements -->
<!--                                     WHERE -->
<!--                                        account IN ( -->
<!--                                        'A00018','A00124','A00141','A00149') -->
<!--                                     ) AS t -->
<!--                                 WHERE -->
<!--                                   vat_number = ?vat;", -->
<!--                                 vat = input$company_select)) %>% -->
<!--     spread(account,value) %>% -->
<!--     replace(., is.na(.),0) %>%    -->
<!--     mutate( -->
<!--       kpi00010 = -A00018/(abs(A00141+A00149)-A00124), -->
<!--       kpi00010 = ifelse(kpi00010 < 0 | is.na(kpi00010), 0, kpi00010) -->
<!--       ) %>% -->
<!--     mutate(date = ymd(paste0(year,"-",month,"-01"))) %>% -->
<!--     select(-vat_number, -year, -month) %>% -->
<!--     select(date,everything()) %>% -->
<!--     arrange(desc(date))}) -->

<!-- renderPlotly( -->
<!--   kpi00010() %>%  -->
<!--     select(NetDebtEbitda = kpi00010, everything()) %>%  -->
<!--     ggplot(aes(x = date, y = NetDebtEbitda)) + -->
<!--     geom_area(fill="#69b3a2", alpha=0.4) + -->
<!--     geom_line(color="#69b3a2") + -->
<!--     geom_point(size = 0.5, color="#69b3a2") + -->
<!--     scale_y_continuous(labels = xs) + -->
<!--     labs( x="",y = "") -->
<!-- ) -->

<!-- ``` -->

<!-- > -->

<!-- ### Debt -->

<!-- ```{r} -->

<!-- debt_kpi <- reactive({ -->
<!--   df() %>%  -->
<!--     select(-financial_statement,-rubrica) %>%  -->
<!--     filter(account %in% c("A00157","A00126","A00139")) %>%  -->
<!--     replace(., is.na(.),0) %>% -->
<!--     gather(key = "date", value = "value",contains("20")) %>%  -->
<!--     spread(key = account, value = value) %>%  -->
<!--     mutate( -->
<!--       date = ymd(date), -->
<!--       endividamento = -A00157 / A00126, -->
<!--       solvabilidade = -A00139 / -A00157, -->
<!--       auto_fin = -A00139/A00126 -->
<!--     ) -->
<!--   }) -->

<!-- renderPlotly( -->

<!--   debt_kpi() %>%  -->
<!--     gather("kpi","value",-contains("date")) %>%  -->
<!--     mutate(kpi = factor(kpi)) %>%  -->
<!--     filter(kpi %in% c("endividamento", "solvabilidade", "auto_fin")) %>%  -->
<!--     ggplot(aes(x = date, y = value, fill = kpi)) +  -->
<!--     #geom_bar(stat = "identity", position=position_dodge())+  -->
<!--     geom_line(aes(color = kpi))+ -->
<!--     geom_point(aes(color = kpi))+ -->
<!--     scale_fill_brewer(palette="Dark2")+ -->
<!--     scale_y_continuous(labels = scales::percent_format(accuracy = 1)) + -->
<!--     labs( x="",y = "") + -->
<!--     theme(legend.position="top") -->
<!-- ) -->

<!-- ``` -->

<!-- > Autonomia financeira = Capital Próprio / Ativo; Solvabilidade = Capital Próprio / Passivo; Endividamento = Passivo / Ativo -->

<!-- Operation {data-orientation=rows data-navmenu=Details} -->
<!-- ======================================================================= -->

<!-- Row {data-width=500} -->
<!-- ----------------------------------------------------------------------- -->

<!-- ### Performance -->

<!-- ```{r} -->

<!-- renderPlotly( -->

<!--   data() %>%  -->
<!--   select(date, contains("kpi")) %>%  -->
<!--   gather("kpi","value",contains("kpi")) %>%  -->
<!--   mutate(kpi = factor(kpi)) %>%  -->
<!--   filter(kpi %in% c("kpi0009","kpi0008","kpi0007")) %>%  -->
<!--   mutate(kpi = forcats::fct_recode(kpi, "ROCE (%)" = "kpi0009", "Ebitda (%)" = "kpi0008", "Gross Margin (%)" = "kpi0007")) %>%  -->
<!--   ggplot(aes(x = date, y = value, group = kpi)) +  -->
<!--   geom_line(aes(color = kpi))+ -->
<!--   geom_point(aes(color = kpi)) + -->
<!--   scale_color_brewer(palette="Dark2")+ -->
<!--   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) + -->
<!--   labs( x="",y = "") + -->
<!--   theme(legend.position="top") -->
<!--   ) -->

<!-- ``` -->

<!-- Row {data-width=500} -->
<!-- ----------------------------------------------------------------------- -->





<!-- Market -->
<!-- ======================================================================= -->

<!-- ```{r} -->
<!-- model <- readRDS("www/model.rds") -->
<!-- oecd <- readRDS("www/prediction_data.rds") -->
<!-- mkt <- readRDS("www/mkt.rds") -->

<!-- data_pred <- oecd %>% -->
<!--   select(year,GDP,GDPV_CAP) %>% -->
<!--   drop_na() -->

<!-- data_pred <- data_pred %>% -->
<!--   mutate(pred = predict(model, data_pred)) %>% -->
<!--   filter(year > 2007) -->


<!-- results <- mkt %>% -->
<!--   right_join(select(data_pred,year, pred), by = "year") %>% -->
<!--   select(year, sales, pred) %>% -->
<!--   mutate(year = as.Date(paste(year, 1, 1, sep = "-"))) %>% -->
<!--   gather(flag, value,-contains("year")) -->

<!-- ``` -->

<!-- ```{r} -->

<!--   plot <- results %>% -->
<!--   ggplot(aes(x = year, y = value)) + -->
<!--   geom_line(aes(color = flag)) + -->
<!--   geom_point(aes(color = flag))+ -->
<!--   scale_color_brewer(palette="Dark2")+ -->
<!--   labs( x="",y = "") + -->
<!--   theme(legend.position="top") -->

<!-- ggplotly(plot) -->

<!-- ``` -->





