---
title: "Dash"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    logo: www/paper_stack_icon_2.png
    orientation: rows
    vertical_layout: fill
    #css: www/my_theme.css
    theme: cerulean
    source_code: "https://github.com/pmags/kpi_dashboard"

---

```{r setup, include=FALSE}

library(flexdashboard)
library(tidyverse)
library(lubridate)
library(RPostgres) # connects to database
library(RPostgreSQL) # sql functions
library(plotly) # allows for web friendly graphs
library(DT) # allows for web friendly data table
library(viridis) # plot color
library(shinysky)

source("R/functions.R")

# Theme set for all plots
theme_set(
  theme_minimal() +
    theme(legend.position = "right"))

```


```{r connection to database, include = FALSE}

con <- dbConnect(RPostgres::Postgres(), 
                dbname = "nors",
                host = "localhost",
                port = 5432,
                user = "psm",
                password = "admin")

```

```{r}

data <- reactive({dbGetQuery(con,sqlInterpolate(ANSI(),
                                "SELECT
                                  vat_number, account,year,month,value
                                FROM
                                  ( SELECT
                                        vat_number, account,year,month,value
                                    FROM
                                        statements
                                    WHERE
                                       account IN (
                                       'A00139','A00125', 'A00124','A00119','A00117','A00151','A00149',
                                       'A00126','A00127','A00131','A00156','A00018','A00001','A00006')
                                    ) AS t
                                WHERE
                                  vat_number = ?vat;",
                                vat = input$company_select)) %>%
    spread(account,value) %>%
    replace(., is.na(.),0) %>%   
    mutate(
      kpi0001 = ((A00125 - A00124 - A00119 - A00117) + (A00156 - A00151 - A00149))/-A00001 * 365,
      kpi0005 = A00139/A00127,
      kpi0006 = A00131/A00127,
      kpi0007 = (A00001+A00006)/A00001,
      kpi0008 = A00018/A00001,
      kpi0009 = A00018/(A00126-A00156),
      wc = (A00125 - A00124 - A00119 - A00117) + (A00156 - A00151 - A00149)
      ) %>%
    mutate(date = ymd(paste0(year,"-",month,"-01"))) %>%
    select(-vat_number, -year, -month) %>%
    select(date,everything()) %>%
    arrange(desc(date))})


```

Sidebar {.sidebar}
====================

```{r}

company <- dbGetQuery(con,"SELECT vat_number, name FROM company;")
Encoding(company$name) <- "UTF-8"

choices <- split(company$vat_number,company$name)

div(style = "font-size:9pt",
    selectInput("company_select", h5("Select company"), 
                       choices = choices, selected = "Galius"))

div(style = "font-size:9pt",
     checkboxGroupInput(inputId = "check_period",
                        label = h5("Periods"),
                        choices = list("Year End" = 1, "Interimn" = 2), selected = c(1,2))
    )

div(style = "font-size:9pt",
    
    sliderInput(inputId = "year_slider",
                label = h5("Years included"),
                min = 2014, max = 2019,
                value = c(2014,2019))
     
    )

```

Use **Select Company** to change company on the dashboard. The options **Periods** allow to only include year end information as the years represented on the dash board can be changed on **years included**.

Click on **Financials** tab for balance sheet, profit and loss, cash flow and funcional balance sheet. Information can be download to excel, csv and pdf.


Application author: [Mosaic](http://mosaic.pt)

Overview
=======================================================================

Row {data-width = 500}
-----------------------------------------------------------------------

### Performance

```{r}
renderPlotly(
  
  data() %>% 
  select(date, contains("kpi")) %>% 
  gather("kpi","value",contains("kpi")) %>% 
  mutate(kpi = factor(kpi)) %>% 
  filter(kpi %in% c("kpi0009","kpi0008","kpi0007")) %>% 
  mutate(kpi = forcats::fct_recode(kpi, "ROCE (%)" = "kpi0009", "Ebitda (%)" = "kpi0008", "Gross Margin (%)" = "kpi0007")) %>% 
  ggplot(aes(x = date, y = value, group = kpi)) + 
  geom_line(aes(color = kpi))+
  geom_point(aes(color = kpi)) +
  scale_color_brewer(palette="Dark2")+
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs( x="",y = "") +
  theme(legend.position="top")
  )

```



Column {data-width=333}
-----------------------------------------------------------------------

### Turnover 

```{r}

renderPlotly(
  data() %>% 
    select(date,turnover = A00001) %>% 
    mutate(month = month(date), 
           turnover = abs(turnover/month*12)) %>% 
    ggplot(aes(x = date, y = turnover)) +
    geom_area(fill="#69b3a2", alpha=0.4) +
    geom_line(color="#69b3a2") +
    geom_point(size = 0.5, color="#69b3a2") +
    scale_y_continuous(labels = ks) +
    labs( x="",y = "")
)

```

> Anualized values

### Working capital

```{r}

renderPlotly(
  data() %>% 
    select(date, working_capital_days = kpi0001, turnover = A00001) %>% 
    mutate(working_capital_days = ifelse(month(date) != 12, 
                                         working_capital_days * turnover/(turnover/month(date)*12), working_capital_days)) %>% 
    ggplot(aes(x = date, y = working_capital_days)) +
    geom_area(fill="#7a69b3", alpha = 0.4) +
    geom_line(color="#7a69b3") +
    geom_point(size = 0.5, color="#7a69b3") +
    labs( x="",y = "")
)

```

> Values in days. Interimn sales converted to yearly values.

### Cash Flow % Sales

```{r}

renderPlotly(
  
  data() %>% 
    mutate(bf = date - years(1)) %>% 
    left_join(select(data(),date, wc), by = c("bf" = "date"), suffix = c(".curr",".bf")) %>% 
    mutate(wc_var = wc.curr - wc.bf, 
           cf_vendas = (A00018 + wc_var)/A00001*100) %>% 
     ggplot(aes(x = date, y = cf_vendas)) +
    geom_area(fill="#d95b5b", alpha = 0.4) +
    geom_line(color="#d95b5b") +
    geom_point(size = 0.5, color="#d95b5b") +
    labs( x="",y = "")
)


```


Column {data-width=333}
-----------------------------------------------------------------------

### Monitorização art 35º

```{r}

renderValueBox(
valueBox(value = prettyNum(data() %>% 
                              filter(month(date) == 12) %>% 
                              filter(date == max(date)) %>% 
                              select(kpi0005) %>%  
                              mutate(kpi0005 = scales::percent(kpi0005)), decimal.mark = ".") ,
         caption = "Capital própio no Capial social",
         icon = "ion-quote"))

```

### Reservas legais

```{r}

renderValueBox(
  valueBox(value = prettyNum(data() %>% 
                               filter(month(date) == 12) %>% 
                               filter(date == max(date)) %>% 
                               select(kpi0006) %>% 
                               mutate(kpi0006 = scales::percent(kpi0006)), decimal.mark = "."),
           caption = "Peso reservas legais",
           icon = "ion-quote")
)

```


Financials
=======================================================================

```{r}

query_sql <- "SELECT vat_number,account,name_pt, year, month,value, financial_statement
                FROM statements AS s
                INNER JOIN account AS a
                ON s.account = a.ies_id
                WHERE vat_number = ?vat;"

df <- reactive({
  dbGetQuery(con,sqlInterpolate(ANSI(), query_sql, vat = input$company_select)) %>%
    mutate(date = ymd(paste0(year,"-",month,"-01"))) %>%
    arrange(desc(date)) %>% 
    select(-year, -month,-vat_number) %>%
    spread(date, value) %>%
    select(rubrica = name_pt, everything())
})

```

```{r}
query2 <- "
SELECT funcional_code, name_pt, vat_number, year, month, value
FROM(

    SELECT funcional_code, vat_number, year, month, SUM(value) AS value
    FROM statements AS s
    INNER JOIN account AS a ON a.ies_id = s.account
    WHERE a.sum_value != true AND
        funcional_code IS NOT NULL
    GROUP BY funcional_code, vat_number, year, month

    UNION

    SELECT 'F0005' AS funcional_code, vat_number, year, month, SUM(value) AS value
    FROM statements AS s
    INNER JOIN account AS a ON a.ies_id = s.account
    INNER JOIN funcional_account AS f USING (funcional_code)
    WHERE a.sum_value != true AND
        f.fmf = true AND
        f.funcional_code IS NOT NULL
    GROUP BY vat_number, year, month

    UNION

    SELECT 'F0011' AS funcional_code, vat_number, year, month, SUM(value) AS value
    FROM statements AS s
    INNER JOIN account AS a ON a.ies_id = s.account
    INNER JOIN funcional_account AS f USING (funcional_code)
    WHERE a.sum_value != true AND
        f.c_needs = true AND
        f.funcional_code IS NOT NULL
    GROUP BY vat_number, year, month

    UNION   

    SELECT 'F0016' AS funcional_code, vat_number, year, month, SUM(value) AS value
    FROM statements AS s
    INNER JOIN account AS a ON a.ies_id = s.account
    INNER JOIN funcional_account AS f USING (funcional_code)
    WHERE a.sum_value != true AND
        f.c_resources = true AND
        f.funcional_code IS NOT NULL
    GROUP BY vat_number, year, month

    UNION

    SELECT 'F0017' AS funcional_code, vat_number, year, month, SUM(value) AS value
    FROM statements AS s
    INNER JOIN account AS a ON a.ies_id = s.account
    INNER JOIN funcional_account AS f USING (funcional_code)
    WHERE a.sum_value != true AND
        f.nfm = true AND
        f.funcional_code IS NOT NULL
    GROUP BY vat_number, year, month

    UNION

    SELECT 'F0020' AS funcional_code, vat_number, year, month, SUM(value) AS value
    FROM statements AS s
    INNER JOIN account AS a ON a.ies_id = s.account
    INNER JOIN funcional_account AS f USING (funcional_code)
    WHERE a.sum_value != true AND
        f.tl = true AND
        f.funcional_code IS NOT NULL
    GROUP BY vat_number, year, month

) AS data
LEFT JOIN funcional_account USING (funcional_code)
WHERE vat_number = ?vat;"


fun_bal <- reactive({
  dbGetQuery(con,sqlInterpolate(ANSI(), query2,vat = input$company_select)) %>%
    mutate(date = ymd(paste0(year,"-",month,"-01"))) %>%
    arrange(desc(date)) %>% 
    select(-year, -month,-vat_number) %>%
    spread(date, value) %>%
    select(rubrica = name_pt, everything())
})

```

```{r}
query3 <- "
SELECT cf_code, name_pt, vat_number, year, month, value
FROM(

    SELECT cf_code, vat_number, year, month, SUM(var) AS value
    FROM (
        SELECT vat_number, account, month, year, 
            value - lag(value) OVER (PARTITION BY account, vat_number ORDER BY year, month) AS var
        FROM statements AS s
        INNER JOIN account AS a ON s.account = a.ies_id
        WHERE financial_statement = 'bs'

        UNION

        SELECT vat_number, account, month, year, value AS var 
        FROM statements AS s
        INNER JOIN account AS a ON s.account = a.ies_id
        WHERE financial_statement = 'pl'

    ) AS var
    INNER JOIN account AS a ON a.ies_id = var.account
    WHERE a.sum_value != true AND
        cf_code IS NOT NULL
    GROUP BY cf_code, vat_number, year, month

    UNION

    SELECT 'CF002' AS cf_code, vat_number, year, month, SUM(var) AS value
    FROM (
        SELECT vat_number, account, month, year, 
            value - lag(value) OVER (PARTITION BY account, vat_number ORDER BY year, month) AS var
        FROM statements AS s
        INNER JOIN account AS a ON s.account = a.ies_id
        WHERE financial_statement = 'bs'

        UNION

        SELECT vat_number, account, month, year, value AS var 
        FROM statements AS s
        INNER JOIN account AS a ON s.account = a.ies_id
        WHERE financial_statement = 'pl'
    ) AS var
    INNER JOIN account AS a ON a.ies_id = var.account
    INNER JOIN cashflow_account AS cf USING (cf_code)
    WHERE a.sum_value != true AND
        cf.cf_economico = true AND
        cf.cf_code IS NOT NULL
    GROUP BY vat_number, year, month

    UNION

    SELECT 'CF006' AS cf_code, vat_number, year, month, SUM(var) AS value
    FROM (
        SELECT vat_number, account, month, year, 
            value - lag(value) OVER (PARTITION BY account, vat_number ORDER BY year, month) AS var
        FROM statements AS s
        INNER JOIN account AS a ON s.account = a.ies_id
        WHERE financial_statement = 'bs'

        UNION

        SELECT vat_number, account, month, year, value AS var 
        FROM statements AS s
        INNER JOIN account AS a ON s.account = a.ies_id
        WHERE financial_statement = 'pl'
    ) AS var
    INNER JOIN account AS a ON a.ies_id = var.account
    INNER JOIN cashflow_account AS cf USING (cf_code)
    WHERE a.sum_value != true AND
        cf.cf_corrente = true AND
        cf.cf_code IS NOT NULL
    GROUP BY vat_number, year, month

    UNION

    SELECT 'CF007' AS cf_code, vat_number, year, month, SUM(var) AS value
    FROM (
        SELECT vat_number, account, month, year, 
            value - lag(value) OVER (PARTITION BY account, vat_number ORDER BY year, month) AS var
        FROM statements AS s
        INNER JOIN account AS a ON s.account = a.ies_id
        WHERE financial_statement = 'bs'

        UNION

        SELECT vat_number, account, month, year, value AS var 
        FROM statements AS s
        INNER JOIN account AS a ON s.account = a.ies_id
        WHERE financial_statement = 'pl'
    ) AS var
    INNER JOIN account AS a ON a.ies_id = var.account
    INNER JOIN cashflow_account AS cf USING (cf_code)
    WHERE a.sum_value != true AND
        cf.cf_operacional = true AND
        cf.cf_code IS NOT NULL
    GROUP BY vat_number, year, month

    UNION

    SELECT 'CF012' AS cf_code, vat_number, year, month, SUM(var) AS value
    FROM (
        SELECT vat_number, account, month, year, 
            value - lag(value) OVER (PARTITION BY account, vat_number ORDER BY year, month) AS var
        FROM statements AS s
        INNER JOIN account AS a ON s.account = a.ies_id
        WHERE financial_statement = 'bs'

        UNION

        SELECT vat_number, account, month, year, value AS var 
        FROM statements AS s
        INNER JOIN account AS a ON s.account = a.ies_id
        WHERE financial_statement = 'pl'
    ) AS var
    INNER JOIN account AS a ON a.ies_id = var.account
    INNER JOIN cashflow_account AS cf USING (cf_code)
    WHERE a.sum_value != true AND
        cf.cf_gerado_tesouraria = true AND
        cf.cf_code IS NOT NULL
    GROUP BY vat_number, year, month

    UNION

    SELECT 'CF018' AS cf_code, vat_number, year, month, SUM(var) AS value
    FROM (
        SELECT vat_number, account, month, year, 
            value - lag(value) OVER (PARTITION BY account, vat_number ORDER BY year, month) AS var
        FROM statements AS s
        INNER JOIN account AS a ON s.account = a.ies_id
        WHERE financial_statement = 'bs'

        UNION

        SELECT vat_number, account, month, year, value AS var 
        FROM statements AS s
        INNER JOIN account AS a ON s.account = a.ies_id
        WHERE financial_statement = 'pl'
    ) AS var
    INNER JOIN account AS a ON a.ies_id = var.account
    INNER JOIN cashflow_account AS cf USING (cf_code)
    WHERE a.sum_value != true AND
        cf.cf_financiamento = true AND
        cf.cf_code IS NOT NULL
    GROUP BY vat_number, year, month

    UNION

    SELECT 'CF019' AS cf_code, vat_number, year, month, SUM(var) AS value
    FROM (
        SELECT vat_number, account, month, year, 
            value - lag(value) OVER (PARTITION BY account, vat_number ORDER BY year, month) AS var
        FROM statements AS s
        INNER JOIN account AS a ON s.account = a.ies_id
        WHERE financial_statement = 'bs'

        UNION

        SELECT vat_number, account, month, year, value * (CASE WHEN account LIKE 'A00026' THEN -1 ELSE 1 END) AS va
        FROM statements AS s
        INNER JOIN account AS a ON s.account = a.ies_id
        WHERE financial_statement = 'pl'
    ) AS var
    INNER JOIN account AS a ON a.ies_id = var.account
    INNER JOIN cashflow_account AS cf USING (cf_code)
    WHERE 
        cf.cf_liquido_tesouraria = true AND
        cf.cf_code IS NOT NULL
    GROUP BY vat_number, year, month

    UNION

    SELECT 'CF024' AS cf_code, vat_number, year, month, SUM(var) AS value
    FROM (
        SELECT vat_number, account, month, year, 
            value - lag(value) OVER (PARTITION BY account, vat_number ORDER BY year, month) AS var
        FROM statements AS s
        INNER JOIN account AS a ON s.account = a.ies_id
        WHERE financial_statement = 'bs'

        UNION

        SELECT vat_number, account, month, year, value AS var 
        FROM statements AS s
        INNER JOIN account AS a ON s.account = a.ies_id
        WHERE financial_statement = 'pl'
    ) AS var
    INNER JOIN account AS a ON a.ies_id = var.account
    INNER JOIN cashflow_account AS cf USING (cf_code)
    WHERE a.sum_value != true AND
        cf.cf_aplicacoes = true AND
        cf.cf_code IS NOT NULL
    GROUP BY vat_number, year, month


) AS data
LEFT JOIN cashflow_account USING (cf_code)
WHERE vat_number = ?vat;
"


cf <- reactive({
  dbGetQuery(con,sqlInterpolate(ANSI(), query3, vat = input$company_select)) %>%
    mutate(date = ymd(paste0(year,"-",month,"-01"))) %>%
    arrange(desc(date)) %>% 
    select(-year, -month,-vat_number) %>%
    spread(date, value) %>%
    select(rubrica = name_pt, everything())
})

```



Column {.tabset}
-----------------------------------------------------------------------

### Balance Sheet

```{r}

renderDataTable(
  df() %>%
  filter(financial_statement == "bs") %>%
  select(-financial_statement) %>%
  DT::datatable(
  rownames = FALSE,
  extensions = "Buttons",
  options = list(
    # adds buttons
    dom = 'Bfrtip',
    buttons = c("copy", "csv", "excel","pdf","print"),
    # number of entries on display
    pageLength = 100,
    initComplete = JS(
       "function(settings, json) {",
        "$(this.api().table().header()).css({'font-size': '8pt'});",
        "}"
    )),
  fillContainer = TRUE) %>%
  DT::formatStyle(colnames(select(df(),-financial_statement)), fontSize = "8pt") %>%
  DT::formatStyle("account",
                  target = "row",
                  fontWeight = styleEqual(c("A00112","A00125","A00126","A00136","A00139","A00145","A00156","A00157","A00158"),
                                          c("bold","bold","bold","bold","bold","bold","bold","bold","bold"))) %>%
  DT::formatRound(columns = colnames(select(df(),-financial_statement,-rubrica,-account)), digits = 0, mark = ".")

)

```

### Profit & Loss

```{r}

renderDataTable(
  
  df() %>% 
  filter(financial_statement == "pl") %>%
  select(-financial_statement) %>% 
  DT::datatable(
  rownames = FALSE,
  extensions = "Buttons",
  options = list(
    # adds buttons
    dom = 'Bfrtip',
    buttons = c("copy", "csv", "excel","pdf","print"),
    # number of entries on display
    pageLength = 100,
    initComplete = JS(
       "function(settings, json) {",
        "$(this.api().table().header()).css({'font-size': '8pt'});",
        "}"
    )), 
  fillContainer = TRUE) %>% 
  DT::formatStyle(colnames(select(df(),-financial_statement)), fontSize = "8pt") %>%
  DT::formatStyle("account",
                  target = "row", 
                  fontWeight = styleEqual(c("A00018","A00021","A00024","A00026"),
                                          c("bold","bold","bold","bold"))) %>% 
  DT::formatRound(columns = colnames(select(df(),-financial_statement,-rubrica,-account)), digits = 0, mark = ".")
  
  )

```

### Funcional balance sheet

```{r}
renderDataTable(
  
  fun_bal() %>% 
  DT::datatable(
  rownames = FALSE,
  extensions = "Buttons",
  options = list(
    # adds buttons
    dom = 'Bfrtip',
    buttons = c("copy", "csv", "excel","pdf","print"),
    # number of entries on display
    pageLength = 100,
    initComplete = JS(
       "function(settings, json) {",
        "$(this.api().table().header()).css({'font-size': '8pt'});",
        "}"
    )), 
  fillContainer = TRUE) %>% 
  DT::formatStyle(colnames(fun_bal()), fontSize = "8pt") %>%
  DT::formatStyle("funcional_code",
                  target = "row", 
                  fontWeight = styleEqual(c("F0005","F0011","F0016","F0017","F0020"),
                                          c("bold","bold","bold","bold","bold"))) %>% 
  DT::formatRound(columns = colnames(select(fun_bal(),-rubrica,-funcional_code)), digits = 0, mark = ".")
  
  )

```

### Cash Flow

```{r}

renderDataTable(
  
  cf() %>% 
  DT::datatable(
  rownames = FALSE,
  extensions = "Buttons",
  options = list(
    # adds buttons
    dom = 'Bfrtip',
    buttons = c("copy", "csv", "excel","pdf","print"),
    # number of entries on display
    pageLength = 100,
    initComplete = JS(
       "function(settings, json) {",
        "$(this.api().table().header()).css({'font-size': '8pt'});",
        "}"
    )), 
  fillContainer = TRUE) %>% 
  DT::formatStyle(colnames(cf()), fontSize = "8pt") %>%
  DT::formatStyle("cf_code",
                  target = "row", 
                  fontWeight = styleEqual(c("CF006","CF007","CF012","CF018","CF019","CF023","CF024"),
                                          c("bold","bold","bold","bold","bold","bold","bold"))) %>% 
  DT::formatRound(columns = colnames(select(cf(),-rubrica,-cf_code)), digits = 0, mark = ".")
  
  )

```


Liquidity & Solvency {data-navmenu=Details}
=======================================================================

Row {data-width=500}
-----------------------------------------------------------------------

### Cash generation

```{r}

cash_kpi <-   reactive({
  fun_bal() %>%
    filter(funcional_code == "F0017") %>%
    rename(account = funcional_code) %>% 
    rbind(df() %>% 
            select(-financial_statement) %>% 
            filter(account %in% c("A00001","A00113","A00115","A00146","A00006","A00007"))) %>% 
    replace(., is.na(.),0) %>% 
    select(-rubrica) %>% 
    gather(key = "date",value = "value", contains("20")) %>% 
    spread(key = account,value = value) %>% 
    mutate(date = ymd(date),
           dwc = F0017 * 365/abs(A00001),
           tme = A00113/A00006 * 365,
           tmr = A00115/abs(A00001) * 365,
           tmp = -A00146/(A00006+A00007)*365,
           ccc = tme + tmr - tmp)
  })

renderPlotly(
  
  cash_kpi() %>% 
    gather("kpi","value",-contains("date")) %>% 
    mutate(kpi = factor(kpi)) %>% 
    filter(kpi %in% c("dwc","ccc")) %>%  
    ggplot(aes(x = date, y = value, group = kpi)) +
    geom_line(aes(color = kpi))+
    geom_point(aes(color = kpi))+
    scale_color_brewer(palette="Dark2")+
    labs( x="",y = "") +
    theme(legend.position="top")
    
)

```

> Cash converstion cycle and Working Capital in days

### Decomposition



Row {data-width=500}
-----------------------------------------------------------------------

### Liquidity

```{r}

liq_kpi <- reactive({
  df() %>% 
    select(-financial_statement,-rubrica) %>% 
    filter(account %in% c("A00124","A00115","A00113","A00156")) %>% 
    replace(., is.na(.),0) %>%
    gather(key = "date", value = "value",contains("20")) %>% 
    spread(key = account, value = value) %>% 
    mutate(
      date = ymd(date),
      liq_geral = (A00115 + A00124 + A00113) / -A00156,
      liq_reduzida = (A00115 + A00124 ) / -A00156,
      liq_imediata = A00124 / -A00156
    )
    
  })

renderPlotly(

  liq_kpi() %>% 
    gather("kpi","value",-contains("date")) %>% 
    mutate(kpi = factor(kpi)) %>% 
    filter(kpi %in% c("liq_geral", "liq_reduzida", "liq_imediata")) %>% 
    ggplot(aes(x = date, y = value, fill = kpi)) + 
    geom_area(alpha=0.4) +
    scale_fill_brewer(palette="Dark2")+
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    labs( x="",y = "") +
    theme(legend.position="top")
)

```

> Current ratio, Quick Ratio, Acid test ratio


### Net Debt to Ebitda

```{r}

kpi00010 <- reactive({dbGetQuery(con,sqlInterpolate(ANSI(),
                                "SELECT
                                  vat_number, account,year,month,value
                                FROM
                                  ( SELECT
                                        vat_number, account,year,month,value
                                    FROM
                                        statements
                                    WHERE
                                       account IN (
                                       'A00018','A00124','A00141','A00149')
                                    ) AS t
                                WHERE
                                  vat_number = ?vat;",
                                vat = input$company_select)) %>%
    spread(account,value) %>%
    replace(., is.na(.),0) %>%   
    mutate(
      kpi00010 = -A00018/(abs(A00141+A00149)-A00124),
      kpi00010 = ifelse(kpi00010 < 0 | is.na(kpi00010), 0, kpi00010)
      ) %>%
    mutate(date = ymd(paste0(year,"-",month,"-01"))) %>%
    select(-vat_number, -year, -month) %>%
    select(date,everything()) %>%
    arrange(desc(date))})

renderPlotly(
  kpi00010() %>% 
    select(NetDebtEbitda = kpi00010, everything()) %>% 
    ggplot(aes(x = date, y = NetDebtEbitda)) +
    geom_area(fill="#69b3a2", alpha=0.4) +
    geom_line(color="#69b3a2") +
    geom_point(size = 0.5, color="#69b3a2") +
    scale_y_continuous(labels = xs) +
    labs( x="",y = "")
)

```

>

### Debt

```{r}

debt_kpi <- reactive({
  df() %>% 
    select(-financial_statement,-rubrica) %>% 
    filter(account %in% c("A00157","A00126","A00139")) %>% 
    replace(., is.na(.),0) %>%
    gather(key = "date", value = "value",contains("20")) %>% 
    spread(key = account, value = value) %>% 
    mutate(
      date = ymd(date),
      endividamento = -A00157 / A00126,
      solvabilidade = -A00139 / -A00157,
      auto_fin = -A00139/A00126
    )
  })

renderPlotly(

  debt_kpi() %>% 
    gather("kpi","value",-contains("date")) %>% 
    mutate(kpi = factor(kpi)) %>% 
    filter(kpi %in% c("endividamento", "solvabilidade", "auto_fin")) %>% 
    ggplot(aes(x = date, y = value, fill = kpi)) + 
    #geom_bar(stat = "identity", position=position_dodge())+ 
    geom_line(aes(color = kpi))+
    geom_point(aes(color = kpi))+
    scale_fill_brewer(palette="Dark2")+
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    labs( x="",y = "") +
    theme(legend.position="top")
)

```

> Autonomia financeira = Capital Próprio / Ativo; Solvabilidade = Capital Próprio / Passivo; Endividamento = Passivo / Ativo

Operation {data-orientation=rows data-navmenu=Details}
=======================================================================

Row {data-width=500}
-----------------------------------------------------------------------

### Performance

```{r}

renderPlotly(
  
  data() %>% 
  select(date, contains("kpi")) %>% 
  gather("kpi","value",contains("kpi")) %>% 
  mutate(kpi = factor(kpi)) %>% 
  filter(kpi %in% c("kpi0009","kpi0008","kpi0007")) %>% 
  mutate(kpi = forcats::fct_recode(kpi, "ROCE (%)" = "kpi0009", "Ebitda (%)" = "kpi0008", "Gross Margin (%)" = "kpi0007")) %>% 
  ggplot(aes(x = date, y = value, group = kpi)) + 
  geom_line(aes(color = kpi))+
  geom_point(aes(color = kpi)) +
  scale_color_brewer(palette="Dark2")+
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs( x="",y = "") +
  theme(legend.position="top")
  )

```

Row {data-width=500}
-----------------------------------------------------------------------



Market
=======================================================================






